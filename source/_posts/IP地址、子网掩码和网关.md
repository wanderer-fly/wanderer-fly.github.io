---
title: IPv4、子网和网关
date: 2025-02-20 17:50:50
tags: 计算机网络 TCP/IP
---

## IPv4地址的结构

 - **IPv4地址是由32位二进制数组成，占用4个字节**
 - **组成部分分为网络号和主机号，IPv4地址分为五类，即A B C D E**

他们的关系如图所示：

![IP地址分类](https://raw.githubusercontent.com/wanderer-fly/GitPic/main/IP地址分类.png)

### A类地址

- A类地址由1字节网络位和3字节主机位组成
- 第一位`0`是类别位，所以我们只有七位网络号可以使用
- 后面的24位为主机位

对于A类地址的结构可以表示为：

```
0 | 网络号（7位） | 主机号（24位）
```

其中，网络字段全0（即00000000）是一个保留字段，表示`本地网络`；网络字段127（即01111111）是另一个保留字段，用于`环回地址（Loopback Address）`（比如`127.0.0.1`表示本机），所以A类地址可以指派的有效网络数为：

```
2^7 - 2 = 128 - 2 = 126
```

有效的 A 类网络号范围是

```
1.0.0.0 - 126.0.0.0
```

### B类地址

- B类地址由2字节网络位和2字节主机位组成
- 前两位`10`为类别位，类别位后面的14位表示网络号
- 后面的16位表示主机号

对于B类地址的结构可以表示为：

```
1 0 | 网络号（14位） | 主机号（16位）
```

由于14 位可用来表示网络号，网络号的总数是：

```
2^14 = 16384
```

其中，`128.0.0.0` 是 B 类地址中的 最小有效网络号，因为它标志着 B 类地址空间的开始。因此， `128.0.0.0` 不能作为一个有效的 B 类网络号。

去除一个保留地址 128.0.0.0，我们剩下的有效网络号个数，即B 类地址可以指派的有效网络号个数是：

```
2^14 - 1 = 16384 - 1 = 16383
```

### C类地址

- C类地址由3字节网络位和1字节主机位组成
- 前三位`110`为类别位，类别位后面的21位表示网络号
- 后面的8位表示主机号

C类地址的结构为

```
1 1 0 | 网络号（21 位） | 主机号（8 位）
```

由于21位可用来表示网络号，网络号的总数是：

```
111111111111111111111（即 2^21 - 1 = 2097151）
```

但是`192.0.0.0`是C类地址的最小有效网络号，是 C 类地址空间的起始地址，它是一个保留地址，因此， `192.0.0.0`被排除在有效网络号之外。

我们剩下的有效网络号个数为：

```
2^21 - 1 = 2097152 - 1 = 2097151
```

### D类地址和E类地址

D类地址为多播地址，E类地址为保留地址保留给今后使用

## 子网

### 子网划分

`子网划分`是网络管理中的一个常见过程，子网划分的目的是将一个网络划分为多个`子网`，每个子网可以拥有独立的地址空间。子网的目的是减少路由表的规模，并提高网络的可管理性和安全性。允许更有效地利用IP地址空间。

IP 地址的主机部分 被进一步拆分成了`子网号`和`主机号`

对于一个A类地址`96.120.0.0`，其中网络部分（注意此处`96.120`是一个`二级网络`而不是网络号，该例子中A类地址的网络号为`96`，即`96.0.0.0`），则剩下的16位为主机号，我们将主机号划分为8位`子网号（Subnet ID）`和8位`主机号（Host ID）`

子网划分后的格式为：

```
网络号（96.120） | 子网号（8 位） | 主机号（8 位）
```

借8位主机号作为子网号，因此划分出来`2^8 = 256`个子网，其中全0子网表示`网络地址`，全1子网表示`广播地址`，不能被使用，所以我们有效的网络数位`2^8 - 2 = 256 - 2 = 254`个

每个子网中剩下8位作为主机号，可以分配给254台主机，即`00000001`到`11111110`

因此我们划分后的子网分别为：

```
第一个子网      96.120.0.0/24       有效主机地址范围：96.120.0.1 到 96.120.0.254
第二个子网      96.120.1.0/24       有效主机地址范围：96.120.1.1 到 96.120.1.254
第三个子网      96.120.2.0/24       有效主机地址范围：96.120.2.1 到 96.120.2.254
……
第256个子网     96.120.255.0/24     有效主机地址范围：96.120.255.1 到 96.120.255.254
```

#### `网络地址`与`广播地址`

- 网络地址

> 网络地址代表某个网络的唯一标识符，在该网络内，所有设备都与该网络相关联。

简单来说，网络地址用来指代该网络本身

例如，对于子网`96.120.0.0/24`，`96.120.0.0`表示这个网络的开始地址，所有主机范围从`96.120.0.1`开始到`96.120.0.254`结束

- 广播地址

> 广播地址用于在特定网络内发送广播消息

广播地址用于发送信息给网络中的所有主机，*所有的主机收到该广播地址发出的数据包都会处理这些数据*

广播地址是该子网中主机部分所有位都为`1`的地址

例如，对于子网`96.120.0.0/24`，`96.120.0.255`为该子网的广播地址

而对于子网`96.120.0.0/28`，子网掩码`/28`表示网络部分占28位，剩余4位是主机部分，所以，子网中有`2^4 = 16`个IP地址

要找广播地址，只需要将主机部分的4个位全部置为1 **（广播地址是该子网中最大（最后）一个地址）**，因此该子网的广播地址为`96.120.0.15`

#### 私有地址

在IPv4地址协议中预留了3个IP地址段，作为私有地址，供组织机构内部使用。

- A类地址：10.0.0.0–10.255.255.255
- B类地址：172.16.0.0–172.31.255.255
- C类地址：192.168.0.0–192.168.255.255

**在外网上，不存在IP地址属于上述范围**

### 子网掩码

因此，为了实现一个子网的划分，我们需要一个合适的`子网掩码（Subnet mask）`，子网掩码用于区分网络号、子网号和主机号

子网掩码的结构和IP地址类似，均为32位二进制数组成，通常写作四组十进制数，每组8位，用`点分十进制`表示，例如`255.255.255.0`的二进制表示为：

```
11111111.11111111.11111111.00000000
```

其中前24位1表示网络号和子网号，后8位0表示主机号

子网掩码的结构分为两部分，为`网络部分（Network Part）`和`主机部分（Host Part）`

- 网络部分对应子网掩码中的`1`，用于标识网络地址和子网地址，网络部分位数表示了该子网的大小
- 主机部分对应子网掩码中的`0`，用于标识具体的主机地址，主机部分位数决定了每个子网可以容纳的主机数量

其中A B C类地址默认子网掩码如下表：

| 地址 | 默子网掩码 |
|------|------------|
|A类地址|255.0.0.0|
|B类地址|255.255.0.0|
|C类地址|255.255.255.0|

#### 子网掩码与网络地址

子网掩码与IP地址进行按位与运算，即`子网掩码 AND IP地址`，可以得到网络地址

对于一个IP地址192.168.1.100和子网掩码255.255.255.0，按位与运算：

```
IP地址      192.168.1.100   ->  11000000.10101000.00000001.00000000
子网掩码    255.255.255.0   ->  11111111.11111111.11111111.00000000
-------------------------------------------------------------------
网络地址    192.168.1.0     ->  11000000.10101000.00000001.00000000
```

得到网络地址为`192.168.1.0`，**网络地址表示该IP所属的网络`

#### 子网掩码的常见表示方法

子网掩码一般使用`点分十进制`和`CIDR (Classless Inter-Domain Routing)`表示，在UNIX中以CIDR更为常见而在Windows中则一般使用点分十进制的方式表示

```
255.255.255.0   <=>     /24     #网络部分24位
255.255.0.0     <=>     /16     #网络部分16位
255.0.0.0       <=>     /8      #网络部分8位
```

#### 使用子网掩码来确定数据包的目的地

有了子网掩码和总路由器，就能确定将数据转发到哪一个子网

对于某一网络`96.120.0.0/18`，网络部分（网络号+子网号占18位，剩下14位为主机号）的子网掩码为`11111111.11111111.11000000.00000000`，即`255.255.192.0`

每个子网有`2^主机位数 - 2个地址`即`2^14 - 2 = 16382`个可用的主机地址（操你妈我刚随手写的什么逆天例子）

假设外界要将一个数据发送到IP地址位`96.120.238.250`的主机，这个数据会先经过路由器，进入`96.120.0.0/18`这个网络中，要确定路由器要将该数据包转发到哪个子网中，首先需要将目标IP转换为二进制，即：

```
96.120.238.250 = 01100000.01111000.11101110.11111010
```

接下来，路由器将目标IP与子网掩码按位与运算，找出网络号+子网号：

```
目标IP      96.120.238.250      01100000.01111000.11101110.11111010
子网掩码    255.255.192.0       11111111.11111111.11000000.00000000
-------------------------------------------------------------------
网络地址                        01100000.01111000.11000000.00000000
```

计算得到的网络地址为：

```
01100000.01111000.11000000.00000000 = 96.120.192.0
```

表明`96.120.238.250`属于`96.120.192.0/18`这个子网

在`96.120.238.250`这个IP中，根据子网掩码的划分我们知道前18位为网络部分，即`网络号+子网号`，后14位属于`主机号`

该地址为一个A类地址，默认的子网掩码为`255.0.0.0`，所以网络号为8位，网络地址为18位，则子网长度为10位，即`011100011`，转换为十进制为`227`，主机为`10111011111010`，十进制为`12026`

路由器将数据转发到第227个子网上，再由子网路由器转发到第12026的主机上

### 网段

要确定两台主机是否在同一网段，必须要做到`网络标识`相同

#### 网络标识

网络标识需要根据子网掩码的位数判断，只需要将IP地址和子网掩码进行按位与运算，例如

```
IP地址      192.168.0.1     11000000.10101000.00000000.00000001
子网掩码    255.255.255.0   11111111.11111111.11111111.00000000
---------------------------------------------------------------
网络标识    192.168.0.0     11000000.10101000.00000000.00000000
```

其中的`192.168.0.0`就是网络标识

简而言之，两个主机的IP地址的网络号和子网号相同，则认为该两台主机处于同一网段

**一般情况下，位于同一网段的两台主机可以 *直接* 访问**

## 网关（Gateway）：内外网的连接点

**网关是一个网络层的概念**

网关实际上是一个网络通向其他网络的IP地址，网关的IP地址是具有路由功能的设备的IP地址（一般来说是路由器、启用了路由功能的服务器或代理服务器）

